<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ホスト設定</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="odai-list.js"></script>
    <style>
        body {
            background: #0047AB;
            font-family: sans-serif;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: white;
        }

        .container { 
            background: rgba(255,255,255,0.2); 
            padding: 20px; 
            border-radius: 20px; 
            width: 360px; /* 他の画面と同じサイズ感に */
            border: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box;
            text-align: center;
        }

        /* 部屋番号を適度な大きさに */
        .room-no { 
            font-size: 42px; 
            font-weight: bold; 
            color: #ffcc00; 
            margin: 5px 0 15px 0;
        }
        
        /* 名前入力 */
        .input-unit { margin-bottom: 15px; text-align: left; }
        .input-unit label { font-size: 14px; display: block; margin-bottom: 5px; opacity: 0.9; }
        .input-unit input { 
            width: 100%; padding: 10px; border-radius: 8px; border: none; 
            font-size: 18px; box-sizing: border-box; text-align: center;
        }

        .section-title { 
            font-size: 15px; margin: 15px 0 8px 0; font-weight: bold; 
            text-align: left; border-left: 4px solid #ffcc00; padding-left: 8px; 
        }

        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }

        .btn-opt { 
            background: rgba(255,255,255,0.25); border: none; color: white; padding: 10px 5px; 
            border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;
        }
        .btn-opt.active { background: #fff; color: #0047AB; }
        
        .input-inline { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .input-inline input { width: 70px; padding: 8px; border-radius: 8px; border: none; text-align: center; font-size: 20px; font-weight: bold; }

        /* 参加者リストをコンパクトに */
        .member-card { background: rgba(0,0,0,0.15); padding: 10px; border-radius: 12px; margin-top: 15px; text-align: left; }
        .member-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; max-height: 60px; overflow-y: auto; }
        .member-chip { background: #ffcc00; color: #333; padding: 3px 10px; border-radius: 15px; font-size: 13px; font-weight: bold; }

        .btn-start { 
            background: #ff4757; color: white; padding: 15px; width: 100%; border: none; 
            border-radius: 12px; font-size: 22px; font-weight: bold; cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <div style="font-size: 13px; opacity: 0.8;">みんなに教える部屋番号</div>
    <div class="room-no" id="roomDisplay">----</div>

    <div class="input-unit">
        <label>あなたのなまえ</label>
        <input type="text" id="hostName" placeholder="なまえを入力">
    </div>

    <div class="section-title">モード</div>
    <div class="button-group" id="modeGroup">
        <button class="btn-opt active" onclick="setMode('battle', this)">個人戦</button>
        <button class="btn-opt" onclick="setMode('coop', this)">協力</button>
    </div>

    <div class="section-title">おわるルール</div>
    <div class="button-group" id="condGroup">
        <button class="btn-opt active" onclick="setCondition('timeLimit', this)">じかん</button>
        <button class="btn-opt" onclick="setCondition('scoreGoal', this)">問題数</button>
    </div>

    <div class="input-inline" style="margin-top: 8px;">
        <input type="number" id="condValue" value="5" inputmode="numeric">
        <span id="condUnit" style="font-weight: bold;">分</span>
    </div>

    <div class="section-title">お題カテゴリ</div>
    <div id="categoryGroup" class="button-group grid-3"></div>

    <div class="member-card">
        <div style="font-size: 13px;">参加中: <span id="count">0</span>人</div>
        <div id="memberNames" class="member-list"></div>
    </div>

    <button class="btn-start" onclick="startGame()">スタート！</button>
</div>

<script>
    // Firebase設定を貼り付けてください
    const config = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    // 1. 部屋番号発行 & DBに仮作成 (これであそびにいく側が入室可能になる)
    let roomID = sessionStorage.getItem('quiz_room');
    if (!roomID) {
        roomID = Math.floor(1000 + Math.random() * 9000);
        sessionStorage.setItem('quiz_room', roomID);
    }
    document.getElementById('roomDisplay').innerText = roomID;

    // 重要: 画面を開いた瞬間にDBに「待機状態」を作る
    db.ref(`rooms/${roomID}/state`).set({ phase: 'setup' });

    let settings = { mode: 'battle', condition: 'timeLimit', category: 'すべて' };

    // カテゴリ生成
    const catGroup = document.getElementById('categoryGroup');
    if (typeof odaiData !== 'undefined') {
        Object.keys(odaiData).forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt' + (cat === 'すべて' ? ' active' : '');
            btn.innerText = cat;
            btn.onclick = () => setCategory(cat, btn);
            catGroup.appendChild(btn);
        });
    }

    function setMode(v, b) { settings.mode = v; toggleActive('modeGroup', b); }
    function setCondition(v, b) {
        settings.condition = v;
        toggleActive('condGroup', b);
        document.getElementById('condUnit').innerText = (v === 'timeLimit' ? "分" : "問");
    }
    function setCategory(v, b) { settings.category = v; toggleActive('categoryGroup', b); }
    function toggleActive(id, b) {
        document.getElementById(id).querySelectorAll('.btn-opt').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
    }

    // 参加者監視
    db.ref(`rooms/${roomID}/users`).on('value', snap => {
        const users = snap.val() || {};
        const listDiv = document.getElementById('memberNames');
        listDiv.innerHTML = "";
        const keys = Object.keys(users);
        document.getElementById('count').innerText = keys.length;
        keys.forEach(k => {
            const chip = document.createElement('span');
            chip.className = 'member-chip';
            chip.innerText = users[k].name;
            listDiv.appendChild(chip);
        });
    });

    async function startGame() {
        const name = document.getElementById('hostName').value.trim();
        if(!name) return alert("なまえを入れてね");
        
        const condVal = document.getElementById('condValue').value;
        const uid = "h-" + Date.now().toString(36);
        
        // ホストを参加者として登録
        await db.ref(`rooms/${roomID}/users/${uid}`).set({ name: name + "(ホスト)", score: 0, image: "" });
        
        // ゲーム開始状態へ更新
        await db.ref(`rooms/${roomID}/state`).update({
            phase: 'playing',
            mode: settings.mode,
            condition: settings.condition,
            conditionValue: parseInt(condVal),
            category: settings.category,
            currentIndex: 0,
            odai: odaiData[settings.category][0],
            startTime: firebase.database.ServerValue.TIMESTAMP,
            totalSolved: 0,
            timer: 60
        });

        sessionStorage.setItem('quiz_uid', uid);
        location.href = 'play.html';
    }
</script>
</body>
</html>
