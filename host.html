<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ホスト設定</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="odai-list.js"></script>
    <style>
        /* 画面全体のスクロールを有効にし、二重スクロールを防止 */
        body {
            background: #0047AB;
            font-family: sans-serif;
            margin: 0;
            padding: 40px 0;
            display: flex;
            justify-content: center;
            color: white;
            min-height: 100vh;
        }

        .container { 
            background: rgba(255,255,255,0.2); 
            padding: 40px; 
            border-radius: 30px; 
            width: 700px; /* 横幅をさらに広げました */
            max-width: 95%;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box;
        }

        /* 部屋番号を一番大きく目立たせる */
        .room-label { font-size: 20px; opacity: 0.9; margin-bottom: 5px; }
        .room-no { 
            font-size: 80px; 
            font-weight: bold; 
            color: #ffcc00; 
            margin-bottom: 30px; 
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
            letter-spacing: 5px;
        }
        
        /* 名前入力エリア */
        .name-input-box { 
            background: rgba(255,255,255,0.15); 
            padding: 30px; 
            border-radius: 20px; 
            margin-bottom: 40px; 
            border: 2px solid rgba(255,255,255,0.2); 
        }
        .name-input-box input { 
            width: 100%; 
            max-width: 500px; 
            padding: 15px; 
            border-radius: 12px; 
            border: none; 
            font-size: 28px; 
            text-align: center; 
            font-weight: bold; 
            color: #333;
            outline: none;
        }

        .section-title { 
            font-size: 24px; 
            margin: 40px 0 20px 0; 
            font-weight: bold; 
            text-align: left; 
            border-left: 10px solid #ffcc00; 
            padding-left: 15px; 
        }

        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }

        .btn-opt { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            padding: 20px 10px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 24px; 
            font-weight: bold; 
            transition: 0.2s;
        }
        .btn-opt.active { 
            background: #fff; 
            color: #0047AB; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
            transform: translateY(-3px); 
        }
        
        .input-inline { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 15px; }
        .input-inline input { 
            width: 140px; 
            padding: 15px; 
            border-radius: 15px; 
            border: none; 
            text-align: center; 
            font-size: 36px; 
            font-weight: bold; 
            color: #333; 
        }
        .cond-text { font-size: 30px; font-weight: bold; }

        .member-card { 
            background: rgba(0,0,0,0.2); 
            padding: 30px; 
            border-radius: 20px; 
            margin-top: 40px; 
            text-align: left; 
        }
        .member-list { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px; }
        .member-chip { 
            background: #ffcc00; 
            color: #333; 
            padding: 12px 24px; 
            border-radius: 40px; 
            font-size: 20px; 
            font-weight: bold; 
        }

        .btn-start { 
            background: #ff4757; 
            color: white; 
            padding: 30px; 
            width: 100%; 
            border: none; 
            border-radius: 20px; 
            font-size: 36px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 50px;
            box-shadow: 0 10px 0 #b3313d;
        }
        .btn-start:active { transform: translateY(5px); box-shadow: 0 2px 0 #b3313d; }
    </style>
</head>
<body>

<div class="container">
    <div class="room-label">みんなに教える部屋番号</div>
    <div class="room-no" id="roomDisplay">----</div>

    <div class="name-input-box">
        <div style="font-size: 20px; margin-bottom: 15px; font-weight: bold;">あなたのなまえ</div>
        <input type="text" id="hostName" placeholder="なまえを入力してください">
    </div>

    <div class="section-title">ゲームモード</div>
    <div class="button-group" id="modeGroup">
        <button class="btn-opt active" onclick="setMode('battle', this)">個人戦</button>
        <button class="btn-opt" onclick="setMode('coop', this)">協力プレイ</button>
    </div>

    <div class="section-title">おわるルール</div>
    <div class="button-group" id="condGroup">
        <button class="btn-opt active" onclick="setCondition('timeLimit', this)">じかん</button>
        <button class="btn-opt" onclick="setCondition('scoreGoal', this)">もんだい数</button>
    </div>

    <div class="input-inline">
        <input type="number" id="condValue" value="5" inputmode="numeric">
        <span id="condUnit" class="cond-text">分</span>
    </div>

    <div class="section-title">お題のカテゴリ</div>
    <div id="categoryGroup" class="button-group grid-3"></div>

    <div class="member-card">
        <div style="font-size: 20px; font-weight: bold;">現在の参加者：<span id="count">0</span>人</div>
        <div id="memberNames" class="member-list"></div>
    </div>

    <button class="btn-start" onclick="startGame()">ゲームを開始する！</button>
</div>

<script>
    // --- Firebase設定（共通のものに書き換えてください） ---
    const config = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    // 1. 画面表示時に即座に番号を発行
    let roomID = sessionStorage.getItem('quiz_room');
    if (!roomID) {
        roomID = Math.floor(1000 + Math.random() * 9000);
        sessionStorage.setItem('quiz_room', roomID);
    }
    document.getElementById('roomDisplay').innerText = roomID;

    let settings = { mode: 'battle', condition: 'timeLimit', category: 'すべて' };

    // カテゴリボタン動的生成
    const catGroup = document.getElementById('categoryGroup');
    if (typeof odaiData !== 'undefined') {
        Object.keys(odaiData).forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt' + (cat === 'すべて' ? ' active' : '');
            btn.innerText = cat;
            btn.onclick = () => setCategory(cat, btn);
            catGroup.appendChild(btn);
        });
    }

    function setMode(v, b) { settings.mode = v; toggleActive('modeGroup', b); }
    function setCondition(v, b) {
        settings.condition = v;
        toggleActive('condGroup', b);
        document.getElementById('condUnit').innerText = (v === 'timeLimit' ? "分" : "問");
    }
    function setCategory(v, b) { settings.category = v; toggleActive('categoryGroup', b); }
    function toggleActive(id, b) {
        document.getElementById(id).querySelectorAll('.btn-opt').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
    }

    // 参加者をリアルタイムで表示
    db.ref(`rooms/${roomID}/users`).on('value', snap => {
        const users = snap.val() || {};
        const listDiv = document.getElementById('memberNames');
        listDiv.innerHTML = "";
        const keys = Object.keys(users);
        document.getElementById('count').innerText = keys.length;
        keys.forEach(k => {
            const chip = document.createElement('span');
            chip.className = 'member-chip';
            chip.innerText = users[k].name;
            listDiv.appendChild(chip);
        });
    });

    async function startGame() {
        const name = document.getElementById('hostName').value.trim();
        if(!name) return alert("まずは、あなたのなまえを入力してください！");
        
        const condVal = document.getElementById('condValue').value;
        const uid = "h-" + Date.now().toString(36); // ホスト用の一時UID
        
        // ホスト自身の情報を保存
        await db.ref(`rooms/${roomID}/users/${uid}`).set({
            name: name + "(ホスト)",
            score: 0,
            image: ""
        });

        // 部屋の初期状態を設定して開始
        await db.ref(`rooms/${roomID}/state`).update({
            phase: 'playing',
            mode: settings.mode,
            condition: settings.condition,
            conditionValue: parseInt(condVal),
            category: settings.category,
            currentIndex: 0,
            odai: odaiData[settings.category][0], // 最初の問題
            startTime: firebase.database.ServerValue.TIMESTAMP,
            totalSolved: 0,
            timer: 60
        });

        sessionStorage.setItem('quiz_uid', uid);
        sessionStorage.setItem('quiz_name', name);

        // ゲーム画面へ
        location.href = 'play.html';
    }
</script>
</body>
</html>
