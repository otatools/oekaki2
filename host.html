<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ホスト設定</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="odai-list.js"></script>
    <style>
        body {
            background: #0047AB;
            font-family: sans-serif;
            margin: 0;
            padding: 20px 0; /* 上下に余白 */
            display: flex;
            justify-content: center;
            color: white;
        }

        .container { 
            background: rgba(255,255,255,0.2); 
            padding: 30px; 
            border-radius: 25px; 
            width: 500px; /* 横幅を広げました */
            max-width: 95%;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box;
        }

        /* 部屋番号表示 */
        .room-no { font-size: 48px; font-weight: bold; color: #ffcc00; margin-bottom: 20px; }
        
        /* 名前入力欄 */
        .name-input-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .name-input-box input { width: 90%; padding: 12px; border-radius: 10px; border: none; font-size: 20px; text-align: center; font-weight: bold; }

        .section-title { font-size: 18px; margin: 20px 0 10px 0; font-weight: bold; text-align: left; border-left: 5px solid #ffcc00; padding-left: 10px; }

        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }

        .btn-opt { 
            background: rgba(255,255,255,0.3); border: none; color: white; padding: 15px 5px; 
            border-radius: 12px; cursor: pointer; font-size: 20px; font-weight: bold; transition: 0.2s;
        }
        .btn-opt.active { background: #fff; color: #0047AB; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .input-inline { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px; }
        .input-inline input { width: 100px; padding: 12px; border-radius: 12px; border: none; text-align: center; font-size: 28px; font-weight: bold; }
        .cond-text { font-size: 22px; }

        .member-card { background: rgba(0,0,0,0.1); padding: 20px; border-radius: 20px; margin-top: 25px; text-align: left; }
        .member-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .member-chip { background: #ffcc00; color: #333; padding: 8px 16px; border-radius: 25px; font-size: 16px; font-weight: bold; }

        .btn-start { 
            background: #ff4757; color: white; padding: 20px; width: 100%; border: none; 
            border-radius: 15px; font-size: 28px; font-weight: bold; cursor: pointer; margin-top: 30px;
            box-shadow: 0 6px 0 #b3313d;
        }
        .btn-start:active { transform: translateY(3px); box-shadow: 0 2px 0 #b3313d; }
    </style>
</head>
<body>

<div class="container">
    <div style="font-size: 16px; opacity: 0.8;">部屋番号</div>
    <div class="room-no" id="roomDisplay">----</div>

    <div class="name-input-box">
        <div style="font-size: 14px; margin-bottom: 8px;">あなたのなまえ</div>
        <input type="text" id="hostName" placeholder="なまえを入力してね">
    </div>

    <div class="section-title">ゲームモード</div>
    <div class="button-group" id="modeGroup">
        <button class="btn-opt active" onclick="setMode('battle', this)">個人戦</button>
        <button class="btn-opt" onclick="setMode('coop', this)">協力</button>
    </div>

    <div class="section-title">おわるルール</div>
    <div class="button-group" id="condGroup">
        <button class="btn-opt active" onclick="setCondition('timeLimit', this)">じかん</button>
        <button class="btn-opt" onclick="setCondition('scoreGoal', this)">もんだい数</button>
    </div>

    <div class="input-inline">
        <input type="number" id="condValue" value="5" inputmode="numeric">
        <span id="condUnit" class="cond-text">分</span>
    </div>

    <div class="section-title">お題のカテゴリ</div>
    <div id="categoryGroup" class="button-group grid-3"></div>

    <div class="member-card">
        <div style="font-size: 16px; font-weight: bold;">参加している人：<span id="count">0</span>人</div>
        <div id="memberNames" class="member-list"></div>
    </div>

    <button class="btn-start" onclick="startGame()">スタート！</button>
</div>

<script>
    // Firebase設定を貼り付け
    const config = { /* ... */ };
    firebase.initializeApp(config);
    const db = firebase.database();

    const roomID = sessionStorage.getItem('quiz_room');
    document.getElementById('roomDisplay').innerText = roomID;

    let settings = { mode: 'battle', condition: 'timeLimit', category: 'すべて' };

    // カテゴリボタン生成
    const catGroup = document.getElementById('categoryGroup');
    if (typeof odaiData !== 'undefined') {
        Object.keys(odaiData).forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt' + (cat === 'すべて' ? ' active' : '');
            btn.innerText = cat;
            btn.onclick = () => setCategory(cat, btn);
            catGroup.appendChild(btn);
        });
    }

    function setMode(v, b) { settings.mode = v; toggleActive('modeGroup', b); }
    function setCondition(v, b) {
        settings.condition = v;
        toggleActive('condGroup', b);
        document.getElementById('condUnit').innerText = (v === 'timeLimit' ? "分" : "問");
    }
    function setCategory(v, b) { settings.category = v; toggleActive('categoryGroup', b); }
    function toggleActive(id, b) {
        document.getElementById(id).querySelectorAll('.btn-opt').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
    }

    // 参加者監視
    db.ref(`rooms/${roomID}/users`).on('value', snap => {
        const users = snap.val() || {};
        const listDiv = document.getElementById('memberNames');
        listDiv.innerHTML = "";
        const keys = Object.keys(users);
        document.getElementById('count').innerText = keys.length;
        keys.forEach(k => {
            const chip = document.createElement('span');
            chip.className = 'member-chip';
            chip.innerText = users[k].name;
            listDiv.appendChild(chip);
        });
    });

    async function startGame() {
        const name = document.getElementById('hostName').value;
        if(!name) return alert("あなたのなまえを入れてね！");
        
        const condVal = document.getElementById('condValue').value;
        const uid = "h-" + Date.now().toString(36);
        
        // ホスト自身をユーザー登録
        await db.ref(`rooms/${roomID}/users/${uid}`).set({ name: name + "(ホスト)", score: 0, image: "" });
        sessionStorage.setItem('quiz_uid', uid);
        sessionStorage.setItem('quiz_name', name);

        // ゲーム状態を更新
        await db.ref(`rooms/${roomID}/state`).update({
            phase: 'playing',
            mode: settings.mode,
            condition: settings.condition,
            conditionValue: parseInt(condVal),
            category: settings.category,
            currentIndex: 0,
            odai: odaiData[settings.category][0],
            startTime: firebase.database.ServerValue.TIMESTAMP,
            totalSolved: 0,
            timer: 60
        });

        location.href = 'play.html';
    }
</script>
</body>
</html>
