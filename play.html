<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>お絵かきクイズ - プレイ</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #0047AB; color: white; font-family: sans-serif; overflow: hidden; height: 100vh; touch-action: none; display: flex; flex-direction: column; }
        
        /* 上部情報 */
        #infoBar { height: 50px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: bold; }
        .timer { color: #ff4757; font-size: 24px; font-variant-numeric: tabular-nums; }

        /* キャンバスエリア */
        #stage { flex: 1; position: relative; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #canvasBox { position: relative; width: 100%; max-width: 100vh; aspect-ratio: 4 / 3; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas, #viewer img { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: contain; }
        #sharedImg:not([src]), #sharedImg[src=""] { opacity: 0; }

        /* ツールバー */
        #toolBar { background: #333; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .tool-row { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .color-btn { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; }
        .size-btn { background: #555; border: 1px solid #777; color: white; padding: 5px 15px; border-radius: 5px; font-size: 14px; cursor: pointer; }
        .size-btn.active { background: #ffcc00; color: #333; font-weight: bold; }
        .btn-action { background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* 回答エリア */
        #answerArea { background: #222; padding: 15px; display: flex; gap: 10px; }
        #answerInput { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 18px; outline: none; }
        #sendBtn { background: #2ed573; color: white; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* お題表示（描く人用） */
        #odaiBox { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(255,204,0,0.95); color: #333; padding: 8px 25px; border-radius: 30px; font-weight: bold; font-size: 22px; z-index: 10; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* 通知トースト */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffcc00; color: #333; padding: 20px 40px; border-radius: 50px; font-size: 40px; font-weight: bold; display: none; z-index: 100; pointer-events: none; border: 5px solid white; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="infoBar">
    <div id="statusText">接続中...</div>
    <div class="timer" id="timerDisplay">60</div>
    <div id="scoreDisplay">正解: 0</div>
</div>

<div id="stage">
    <div id="odaiBox" style="display:none;">お題: <span id="odaiWord">???</span></div>
    <div id="canvasBox">
        <canvas id="canvas"></canvas>
        <div id="viewer" style="display:none;"><img id="sharedImg"></div>
    </div>
</div>

<div id="toolBar" style="display:none;">
    <div class="tool-row">
        <div class="color-btn" style="background:black" onclick="setColor('#000')"></div>
        <div class="color-btn" style="background:red" onclick="setColor('#f00')"></div>
        <div class="color-btn" style="background:blue" onclick="setColor('#00f')"></div>
        <div class="color-btn" style="background:green" onclick="setColor('#080')"></div>
        <div class="color-btn" style="background:white; border:2px solid #ccc" onclick="setColor('#fff')"></div>
        <button class="btn-action" style="background:#555" onclick="clearCanvas()">ぜんぶ消す</button>
    </div>
    <div class="tool-row">
        <button class="size-btn active" onclick="setSize(5, this)">細</button>
        <button class="size-btn" onclick="setSize(10, this)">中</button>
        <button class="size-btn" onclick="setSize(20, this)">太</button>
    </div>
</div>

<div id="answerArea" style="display:none;">
    <input type="text" id="answerInput" placeholder="答えを入力！">
    <button id="sendBtn" onclick="checkAnswer()">送信</button>
</div>

<div id="toast">正解！！</div>

<script>
    // Firebase設定（host.htmlと同じものを設定）
    const config = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const roomID = sessionStorage.getItem('quiz_room');
    const myUid = sessionStorage.getItem('quiz_uid');
    
    if(!roomID || !myUid) { location.href = "index.html"; }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let isDrawer = false;
    let currentOdai = "";

    // キャンバスサイズ設定
    function resize() {
        const box = document.getElementById('canvasBox');
        canvas.width = box.clientWidth;
        canvas.height = box.clientHeight;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    }
    window.addEventListener('resize', resize);
    resize();

    // ツール設定
    let curColor = '#000';
    let curSize = 5;
    function setColor(c) { curColor = c; }
    function setSize(s, btn) {
        curSize = s;
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        uploadImage();
    }

    // お絵描きロジック
    canvas.addEventListener('pointerdown', startDraw);
    canvas.addEventListener('pointermove', draw);
    window.addEventListener('pointerup', stopDraw);

    function startDraw(e) {
        if(!isDrawer) return;
        drawing = true;
        ctx.beginPath();
        const rect = canvas.getBoundingClientRect();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }
    function draw(e) {
        if(!drawing || !isDrawer) return;
        const rect = canvas.getBoundingClientRect();
        ctx.strokeStyle = curColor;
        ctx.lineWidth = curSize;
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    }
    function stopDraw() {
        if(!drawing) return;
        drawing = false;
        uploadImage();
    }

    // 画像アップロード（軽量化のためwebp/品質下げ）
    function uploadImage() {
        const data = canvas.toDataURL('image/webp', 0.2);
        db.ref(`rooms/${roomID}/users/${myUid}`).update({ image: data });
    }

    // リアルタイム同期
    db.ref(`rooms/${roomID}`).on('value', snap => {
        const data = snap.val();
        if(!data) return;

        const state = data.state;
        const users = data.users;
        
        // 終了判定
        if(state.phase === 'result') {
            location.href = 'result.html';
            return;
        }

        const userKeys = Object.keys(users).sort();
        const drawerUid = userKeys[state.currentIndex % userKeys.length];

        // 役割の変化をチェック
        const wasDrawer = isDrawer;
        isDrawer = (myUid === drawerUid);

        // 交代した時にキャンバスを白紙に戻す（自分だけ）
        if(!wasDrawer && isDrawer) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            db.ref(`rooms/${roomID}/users/${myUid}`).update({ image: "" });
        }

        // UI切り替え
        document.getElementById('toolBar').style.display = isDrawer ? 'block' : 'none';
        document.getElementById('odaiBox').style.display = isDrawer ? 'block' : 'none';
        document.getElementById('answerArea').style.display = isDrawer ? 'none' : 'flex';
        document.getElementById('canvas').style.display = isDrawer ? 'block' : 'none';
        document.getElementById('viewer').style.display = isDrawer ? 'none' : 'block';
        
        document.getElementById('statusText').innerText = isDrawer ? "あなたの番！" : users[drawerUid].name + "さんが描画中";
        document.getElementById('odaiWord').innerText = state.odai || "???";
        currentOdai = state.odai;

        // タイマーとスコア
        document.getElementById('timerDisplay').innerText = state.timer;
        const myScore = users[myUid].score || 0;
        const modeText = state.mode === 'coop' ? "みんなの合計: " + (state.totalSolved || 0) : "じぶんの正解: " + myScore;
        document.getElementById('scoreDisplay').innerText = modeText;
        
        // 画像受信（見る人用）
        if(!isDrawer) {
            document.getElementById('sharedImg').src = users[drawerUid].image || "";
        }
    });

    // 答え合わせ
    function checkAnswer() {
        const input = document.getElementById('answerInput');
        const ans = input.value.trim();
        
        if(ans === currentOdai) {
            showToast();
            input.value = "";
            
            // スコア加算
            db.ref(`rooms/${roomID}/users/${myUid}/score`).transaction(s => (s || 0) + 1);
            db.ref(`rooms/${roomID}/state/totalSolved`).transaction(s => (s || 0) + 1);
            
            // ホストに次のお題へ行くよう通知（currentIndexを増やす）
            db.ref(`rooms/${roomID}/state`).update({
                timer: 60, // ターン時間をリセット
                currentIndex: firebase.database.ServerValue.increment(1),
                odai: "抽選中..."
            });
        } else {
            // 間違えた時のちょっとした揺れ演出
            input.style.background = "#ffcccc";
            setTimeout(() => input.style.background = "white", 200);
        }
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1500);
    }

    // Enterキーで送信
    document.getElementById('answerInput').addEventListener('keypress', e => {
        if(e.key === 'Enter') checkAnswer();
    });
</script>
</body>
</html>